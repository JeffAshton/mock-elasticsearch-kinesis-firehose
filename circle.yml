machine:
  node:
    version: 4.7.1
  services:
    - docker

dependencies:
  override:
    - npm prune
    - npm install

test:
  override:
    - npm run ci
    - npm run docker.build

deployment:
  release:
    tag: /v[0-9]+(\.[0-9]+)*/
    commands:
      - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" -e no-reply@circleci.com
      - npm run docker.buildAndPush :
        environment:
          DOCKER_BUILD_TAG: "1.1.0"
